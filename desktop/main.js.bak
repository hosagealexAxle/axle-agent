const { app, BrowserWindow } = require("electron");
const path = require("path");
const http = require("http");
const { spawn } = require("child_process");

const BACKEND_HEALTH = "http://localhost:4000/api/health";

// ----- helpers -----
function ping(url, timeoutMs = 800) {
  return new Promise((resolve) => {
    const req = http.get(url, (res) => {
      res.resume();
      resolve(res.statusCode && res.statusCode >= 200 && res.statusCode < 500);
    });
    req.on("error", () => resolve(false));
    req.setTimeout(timeoutMs, () => {
      req.destroy();
      resolve(false);
    });
  });
}

function sleep(ms) {
  return new Promise((r) => setTimeout(r, ms));
}

function offlineHtml(msg) {
  const safeMsg = (msg || "").replace(/</g, "&lt;").replace(/>/g, "&gt;");
  return `<!doctype html>
  <html>
    <head>
      <meta charset="utf-8" />
      <title>Axle — Starting</title>
      <style>
        body {
          margin: 0;
          font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
          background: linear-gradient(180deg, #0b1220 0%, #070b12 100%);
          color: #e5e7eb;
          height: 100vh;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        .card {
          width: 760px;
          max-width: calc(100vw - 40px);
          border-radius: 18px;
          padding: 18px;
          background: rgba(255,255,255,0.05);
          border: 1px solid rgba(255,255,255,0.10);
          box-shadow: 0 12px 40px rgba(0,0,0,0.35);
        }
        h1 { margin: 0 0 8px; font-size: 20px; }
        p { margin: 0 0 12px; opacity: 0.85; line-height: 1.4; }
        code {
          padding: 2px 6px;
          border-radius: 8px;
          background: rgba(255,255,255,0.08);
          border: 1px solid rgba(255,255,255,0.12);
        }
        .status { margin-top: 10px; font-size: 12px; opacity: 0.75; }
        .row { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
        .btn {
          padding: 10px 12px;
          border-radius: 12px;
          background: rgba(255,255,255,0.08);
          border: 1px solid rgba(255,255,255,0.14);
          color: #fff;
          cursor: pointer;
          font-weight: 700;
        }
        .warn { color:#fbbf24; }
      </style>
    </head>
    <body>
      <div class="card">
        <h1>Axle is starting…</h1>
        <p class="warn"><b>${safeMsg || "Waiting for backend…"}</b></p>
        <p>Backend health check:</p>
        <p><code>${BACKEND_HEALTH}</code></p>
        <div class="row">
          <button class="btn" onclick="location.reload()">Retry</button>
        </div>
        <div class="status">If this keeps spinning, your backend didn’t start. We’ll fix it in Step 5.</div>
      </div>
    </body>
  </html>`;
}

// ----- single-instance lock (prevents “million windows”) -----
const gotLock = app.requestSingleInstanceLock();
if (!gotLock) {
  app.quit();
} else {
  app.on("second-instance", () => {
    const win = BrowserWindow.getAllWindows()[0];
    if (win) {
      if (win.isMinimized()) win.restore();
      win.focus();
    }
  });
}

// ----- paths -----
function isDev() {
  return process.env.AXLE_DEV === "1";
}

function dashboardIndexPath() {
  // DEV: load Vite server
  // PROD: load bundled dashboard from resources
  if (isDev()) return null;
  return path.join(process.resourcesPath, "dashboard", "dist", "index.html");
}

function backendDir() {
  if (isDev()) return path.join(__dirname, "..", "backend");
  return path.join(process.resourcesPath, "backend");
}

function backendEntry() {
  return path.join(backendDir(), "src", "server.js");
}

let backendProc = null;

function startBackend() {
  if (backendProc && !backendProc.killed) return;

  const entry = backendEntry();

  backendProc = spawn(process.execPath, [entry], {
    cwd: backendDir(),
    env: {
      ...process.env,
      ELECTRON_RUN_AS_NODE: "1",
      PORT: "4000"
    },
    stdio: "ignore"
  });

  backendProc.on("error", (err) => {
    console.error("Backend spawn error:", err);
  });

  backendProc.on("exit", (code) => {
    console.log("Backend exited:", code);
  });
}

async function waitForBackend(win) {
  // show splash immediately
  await win.loadURL("data:text/html;charset=utf-8," + encodeURIComponent(offlineHtml("Starting backend…")));

  startBackend();

  // wait up to ~30s for backend
  for (let i = 0; i < 30; i++) {
    const ok = await ping(BACKEND_HEALTH);
    if (ok) return true;
    await win.loadURL("data:text/html;charset=utf-8," + encodeURIComponent(offlineHtml("Waiting for backend…")));
    await sleep(1000);
  }

  await win.loadURL("data:text/html;charset=utf-8," + encodeURIComponent(offlineHtml("Backend did not start. (We’ll fix in Step 5)")));
  return false;
}

async function createWindow() {
  const win = new BrowserWindow({
    width: 1400,
    height: 900,
    backgroundColor: "#0b1220",
    icon: path.join(__dirname, "assets", "icon.icns"),
    webPreferences: {
      nodeIntegration: false,
      contextIsolation: true
    }
  });

  if (isDev()) {
    // DEV: point at Vite
    await win.loadURL("http://localhost:5173");
    return;
  }

  // PROD: ensure backend is alive then load file
  const ok = await waitForBackend(win);
  if (!ok) return;

  const dash = dashboardIndexPath();
  await win.loadFile(dash);
}

app.whenReady().then(() => {
  createWindow();

  app.on("activate", () => {
    if (BrowserWindow.getAllWindows().length === 0) createWindow();
  });
});

app.on("before-quit", () => {
  try {
    if (backendProc && !backendProc.killed) backendProc.kill();
  } catch {}
});

app.on("window-all-closed", () => {
  if (process.platform !== "darwin") app.quit();
});
