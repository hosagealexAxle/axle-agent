generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Thread {
  id        String    @id @default(cuid())
  title     String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  messages  Message[]
}

model Message {
  id        String   @id @default(cuid())
  threadId  String
  role      String   // "user" | "assistant" | "system"
  content   String
  createdAt DateTime @default(now())

  thread Thread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([threadId, createdAt])
}

model ShopSnapshot {
  id              String   @id @default(cuid())
  shopId           String
  period          String
  visits          Int?
  orders          Int?
  revenueUsd      Float?
  conversionRate  Float?
  trafficEtsyApp  Int?
  trafficDirect   Int?
  trafficSeo      Int?
  trafficSearch   Int?
  trafficSocial   Int?
  adsStatus       String?
  capturedAt      DateTime @default(now())
}

model ListingMetric {
  id              String   @id @default(cuid())
  shopId          String
  listingId       String
  title           String?
  priceUsd        Float?
  visits          Int?
  orders          Int?
  revenueUsd      Float?
  conversionRate  Float?
  capturedAt      DateTime @default(now())
}

model ActionLog {
  id         String   @id @default(cuid())
  type       String
  label      String   @default("")
  detail     String   @default("")
  amountUsd  Float?
  ok         Boolean  @default(true)
  createdAt  DateTime @default(now())
}

model BudgetLedger {
  id         String   @id @default(cuid())
  category   String
  amountUsd  Float
  description String?
  metaJson   Json?
  createdAt  DateTime @default(now())
}

model SystemState {
  id        String   @id @default("global")
  metaJson  Json?
  updatedAt DateTime @updatedAt
}

model KeyFact {
  id        String   @id @default(cuid())
  category  String   // "preference", "strategy", "product", "rule", "note"
  content   String
  source    String?  // "user", "llm", "system"
  pinned    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EtsyToken {
  id            String   @id @default("default")
  accessToken   String
  refreshToken  String
  expiresAt     DateTime
  etsyUserId    String?
  shopId        String?
  updatedAt     DateTime @updatedAt
}

model AgentTask {
  id            String   @id @default(cuid())
  type          String   // "seo_optimize", "listing_refresh", "ad_launch", "analysis", "custom"
  title         String
  description   String
  status        String   @default("pending") // "pending", "approved", "running", "completed", "failed", "needs_approval"
  priority      Int      @default(5) // 1=highest, 10=lowest
  estimatedCost Float?   // estimated USD cost
  actualCost    Float?   // actual USD spent
  resultJson    String?  // JSON result data
  errorMessage  String?
  targetId      String?  // listing ID or other target
  autoApproved  Boolean  @default(false)
  scheduledFor  DateTime? // when to run (null = run ASAP)
  startedAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([status, scheduledFor])
}

model PinterestToken {
  id            String   @id @default("default")
  accessToken   String
  refreshToken  String
  expiresAt     DateTime
  username      String?
  updatedAt     DateTime @updatedAt
}

model RoiTracker {
  id              String   @id @default(cuid())
  taskId          String?  // linked AgentTask
  actionType      String   // "seo_change", "listing_refresh", "ad_spend", etc.
  targetId        String?  // listing ID
  targetTitle     String?
  costUsd         Float    @default(0)
  // Before metrics (snapshot at action time)
  beforeVisits    Int?
  beforeOrders    Int?
  beforeRevenue   Float?
  beforeCvr       Float?
  // After metrics (measured later)
  afterVisits     Int?
  afterOrders     Int?
  afterRevenue    Float?
  afterCvr        Float?
  // Calculated
  revenueChange   Float?
  roiMultiple     Float?   // (revenue gained) / cost
  measuredAt      DateTime?
  period          String   @default("7d") // measurement window
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
